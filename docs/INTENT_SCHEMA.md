# Intent Schema（InnerVoice）

## 概要
InnerVoiceのIntent Busで使用されるIntent/Plan/Actionのスキーマ定義です。

## Intent
ユーザーの「やりたいこと」をJSON化したもの。

```typescript
interface Intent {
  id: string;
  text: string;           // 元のテキスト入力
  type: IntentType;       // "task" | "event" | "message" | "reminder" | "mixed"
  entities: Entity[];     // 抽出されたエンティティ
  confidence: number;     // 0-1の信頼度
  created_at: string;
}

interface Entity {
  type: "time" | "person" | "location" | "action" | "duration";
  value: string;
  metadata?: Record<string, any>;
}

type IntentType = "task" | "event" | "message" | "reminder" | "mixed";
```

**例:**
```json
{
  "id": "int_abc123",
  "text": "明日朝7時に30分ランニングして、妻に連絡",
  "type": "mixed",
  "entities": [
    {
      "type": "time",
      "value": "2025-09-19T07:00:00+09:00"
    },
    {
      "type": "duration",
      "value": "30",
      "metadata": { "unit": "minutes" }
    },
    {
      "type": "action",
      "value": "ランニング"
    },
    {
      "type": "person",
      "value": "妻"
    },
    {
      "type": "action",
      "value": "連絡"
    }
  ],
  "confidence": 0.92,
  "created_at": "2025-09-19T06:00:00Z"
}
```

## Plan
Intentから生成された実行プラン。

```typescript
interface Plan {
  id: string;
  intent_id: string;
  summary: string;        // 人間が読める要約
  actions: Action[];      // 実行するアクション群
  minutes_back: number;   // 見積もり短縮時間
  created_at: string;
}

interface Action {
  action: ActionType;     // アクション種別
  [key: string]: any;     // アクション固有のパラメータ
}

type ActionType = 
  | "calendar.create"
  | "message.send"
  | "reminder.create"
  | "task.create";
```

**例:**
```json
{
  "id": "pl_xyz789",
  "intent_id": "int_abc123",
  "summary": "07:00-07:30 朝ラン + 妻にメッセ + 06:45リマインド",
  "actions": [
    {
      "action": "calendar.create",
      "title": "朝ラン",
      "start": "2025-09-19T07:00:00+09:00",
      "duration_min": 30,
      "description": "Generated by InnerVoice"
    },
    {
      "action": "message.send",
      "to": "妻",
      "text": "7時に走ってくるね"
    },
    {
      "action": "reminder.create",
      "time": "2025-09-19T06:45:00+09:00",
      "note": "ストレッチ準備"
    }
  ],
  "minutes_back": 18,
  "created_at": "2025-09-19T06:00:05Z"
}
```

## Execution
プランの実行結果。

```typescript
interface Execution {
  id: string;
  plan_id: string;
  status: ExecutionStatus;
  results: ExecutionResult[];
  minutes_back: number;   // 実際の短縮時間
  started_at: string;
  completed_at?: string;
}

type ExecutionStatus = "pending" | "running" | "completed" | "partial" | "failed";

interface ExecutionResult {
  action: ActionType;
  status: "ok" | "error";
  id?: string;            // 作成されたリソースID
  error?: string;         // エラーメッセージ
  latency_ms?: number;
}
```

**例:**
```json
{
  "id": "exec_def456",
  "plan_id": "pl_xyz789",
  "status": "completed",
  "results": [
    {
      "action": "calendar.create",
      "status": "ok",
      "id": "evt_111",
      "latency_ms": 342
    },
    {
      "action": "message.send",
      "status": "ok",
      "id": "msg_222",
      "latency_ms": 156
    },
    {
      "action": "reminder.create",
      "status": "ok",
      "id": "rmd_333",
      "latency_ms": 89
    }
  ],
  "minutes_back": 18,
  "started_at": "2025-09-19T06:00:10Z",
  "completed_at": "2025-09-19T06:00:11Z"
}
```

## Validation
すべてのスキーマは[Zod](https://zod.dev/)を使用してバリデーションされます。

実装: `lib/intent.ts`

## 実装ステータス
✅ **v0.2.0-alpha.1**: Intent/Plan/Executionのスキーマ定義とDB保存機能
🚧 **v0.3.0**: 実際のConnector統合と並列実行
