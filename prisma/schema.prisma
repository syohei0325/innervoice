// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  emailHash  String   @unique @map("email_hash")
  createdAt  DateTime @default(now()) @map("created_at")

  profile          Profile?
  proposals        Proposal[]
  decisions        Decision[]
  events           Event[]
  deletionRequests DeletionRequest[]
  intents          Intent[]
  plans            Plan[]
  connectors       Connector[]
  memories         Memory[]
  observations     Observation[]
  nudges           Nudge[]

  @@map("users")
}

model Profile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  tz              String   @default("Asia/Tokyo")
  displayName     String?  @map("display_name")
  commuteMinutes  Int?     @map("commute_minutes")
  sleepWindow     String?  @map("sleep_window")
  ngHoursJson     String?  @map("ng_hours_json")
  mobilityPref    String?  @map("mobility_pref")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// PDV (Personal Data Vault) - Á´ØÊú´ÂÑ™ÂÖà„ÅßÂêåÊúü
model Pdv {
  userId    String   @id @map("user_id")
  kvJson    String   @map("kv_json") // JSON key-value store
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pdv")
}

// Savings - Money-Back tracking
model Saving {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  amountYen Int      @map("amount_yen")
  category  String   // subscription_cancel|price_negotiation|coupon|cashback
  source    String   // plan_id or action_id
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("savings")
}

// Consents - Partner/Áî®ÈÄîÂà•ÂêåÊÑè
model Consent {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  scopeJson  String    @map("scope_json") // { "partner": "...", "scopes": ["location", "calendar"] }
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  revokedAt  DateTime? @map("revoked_at")

  @@index([userId, createdAt])
  @@map("consents")
}

// Docs - ÁîüÊàêÊõ∏È°û
model Doc {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  type       String   // pdf|docx|ics|csv
  storageUri String   @map("storage_uri")
  hash       String   // SHA-256 for integrity
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("docs")
}

// Approvals - ConfirmOS
model Approval {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  approveId  String   @unique @map("approve_id") // aprv_xxx
  planId     String?  @map("plan_id")
  scopeJson  String   @map("scope_json") // { "actions": [...], "risk_level": "low|medium|high" }
  expiresAt  DateTime @map("expires_at") // 10ÂàÜÂæå
  createdAt  DateTime @default(now()) @map("created_at")
  usedAt     DateTime? @map("used_at")

  @@index([approveId])
  @@index([userId, createdAt])
  @@map("approvals")
}

// Audit Logs - Áõ£Êüª
model AuditLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  approveId   String?  @map("approve_id")
  action      String   // approve|confirm|cancel|rollback
  payloadJson String   @map("payload_json")
  at          DateTime @default(now())

  @@index([userId, at])
  @@index([approveId])
  @@map("audit_logs")
}

// Execution Ledger - Âè∞Â∏≥ÔºàÊîπ„Åñ„ÇìÊ§úÁü•ÂØæÂøúÔºâ
model LedgerEvent {
  id           String    @id @default(cuid())
  approveId    String?   @map("approve_id")
  planId       String?   @map("plan_id")
  action       String    // calendar.create|message.send|call.placeÁ≠â
  actor        String    // user|automation
  status       String    // approved|executed|failed|rolled_back
  beforeJson   String?   @map("before_json")
  afterJson    String?   @map("after_json")
  reversible   Boolean   @default(true)
  rollbackId   String?   @map("rollback_id")
  ts           DateTime  @default(now())
  prevHash     String?   @map("prev_hash") // Êîπ„Åñ„ÇìÊ§úÁü•Áî®„Éè„ÉÉ„Ç∑„É•„ÉÅ„Çß„Éº„É≥

  @@index([approveId, ts])
  @@index([planId, ts])
  @@map("ledger_events")
}

// Vibe Profiles - „Éë„Éº„ÇΩ„Éä„É©„Ç§„Çº„Éº„Ç∑„Éß„É≥
model VibeProfile {
  userId            String   @id @map("user_id")
  tone              String   @default("friendly") // friendly|coach|concise|warm
  decisiveness      String   @default("balanced") // quick|balanced|cautious
  frugality         String   @default("mid") // low|mid|high
  notificationStyle String   @default("push") // push|silent|scheduled
  language          String   @default("ja-JP")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("vibe_profiles")
}

// Reason Feedbacks - Why-this „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
model ReasonFeedback {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  planId    String   @map("plan_id")
  reasonKey String   @map("reason_key")
  voteBool  Boolean  @map("vote_bool") // true=üëç, false=üëé
  tag       String?  // too_expensive|too_far|too_crowdedÁ≠â
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("reason_feedbacks")
}

// Personalization Stats - ÂÄã‰∫∫ÂåñÁµ±Ë®à
model PersonalizationStat {
  userId          String   @id @map("user_id")
  date            DateTime @db.Date
  top1Rate        Float?   @map("top1_rate")
  editDistancePct Float?   @map("edit_distance_pct")
  ttcP50Ms        Int?     @map("ttc_p50_ms")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("personalization_stats")
}

// Friction Events - FEAÈõÜË®àÁî®
model FrictionEvent {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // copy_paste_avoided|app_switch_avoided|typing_avoided_chars|search_avoided|form_fill_avoided|call_tree_avoided
  qty       Int      // ‰ª∂Êï∞ or ÊñáÂ≠óÊï∞
  evidence  String   // measured|inferred|baseline
  action    String?  // Èñ¢ÈÄ£„Ç¢„ÇØ„Ç∑„Éß„É≥
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("friction_events")
}

model Proposal {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  payloadJson String   @map("payload_json")
  createdAt   DateTime @default(now()) @map("created_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  decisions Decision[]

  @@map("proposals")
}

model Decision {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  proposalId  String   @map("proposal_id")
  icsBlob     String   @map("ics_blob")
  minutesBack Int      @map("minutes_back")
  decidedAt   DateTime @default(now()) @map("decided_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  proposal Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([userId, decidedAt])
  @@map("decisions")
}

model Event {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  source      String
  minutesBack Int?     @map("minutes_back")
  metaJson    String?  @map("meta_json")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("events")
}

model DeletionRequest {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  status      String   @default("pending")
  requestedAt DateTime @default(now()) @map("requested_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("deletion_requests")
}

// MVP+ „ÉÜ„Éº„Éñ„É´ËøΩÂä†
model Intent {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  text      String
  json      String   @map("json")
  createdAt DateTime @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  plans Plan[]

  @@map("intents")
}

model Plan {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  intentId    String   @map("intent_id")
  actionsJson String   @map("actions_json")
  createdAt   DateTime @default(now()) @map("created_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  intent     Intent      @relation(fields: [intentId], references: [id], onDelete: Cascade)
  executions Execution[]

  @@index([userId, createdAt])
  @@map("plans")
}

model Execution {
  id          String   @id @default(cuid())
  planId      String   @map("plan_id")
  status      String   @default("pending")
  resultsJson String?  @map("results_json")
  createdAt   DateTime @default(now()) @map("created_at")

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, createdAt])
  @@map("executions")
}

model Connector {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  provider   String
  enabled    Boolean  @default(true)
  scopesJson String?  @map("scopes_json")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("connectors")
}

// Doraemon Mode: Memory OS
model Memory {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  kind       String    // preference|fact|alias|goal|routine|relationship_note|autopilot_rule
  key        String
  valueJson  String    @map("value_json")
  source     String?   // utterance|action|calendar|message_meta|import|manual
  confidence Float?    @default(1.0)
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId, key])
  @@map("memories")
}

// Doraemon Mode: Proactive OS - Observations
model Observation {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  signal      String   // free_slot|relationship_gap|deadline_near|habit_window|location|open_loop
  payloadJson String   @map("payload_json")
  observedAt  DateTime @default(now()) @map("observed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, observedAt])
  @@map("observations")
}

// Doraemon Mode: Proactive OS - Nudges
model Nudge {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  summary    String
  planJson   String    @map("plan_json")
  reasonKeys String[]  @map("reason_keys")
  status     String    @default("shown") // shown|accepted|dismissed|snoozed|expired
  createdAt  DateTime  @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("nudges")
}

// Doraemon Mode: Relationship Graph
model ContactGraph {
  userId      String    @map("user_id")
  contactId   String    @map("contact_id")
  tieStrength Float?    @map("tie_strength")
  lastMetAt   DateTime? @map("last_met_at")
  lastMsgAt   DateTime? @map("last_msg_at")
  cadenceDays Int?      @map("cadence_days")
  channelsJson String?  @map("channels_json")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@id([userId, contactId])
  @@index([userId, updatedAt])
  @@map("contact_graph")
}

// Doraemon Mode: Availability
model Availability {
  userId     String   @map("user_id")
  date       DateTime @db.Date
  slotsJson  String   @map("slots_json")
  source     String?  // calendar|manual
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@id([userId, date])
  @@map("availability")
}

// Pluggable Memory: Provider Events
model ProviderEvent {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  provider    String   // supermemory|zep|mem0
  event       String   // search|health|error
  payloadJson String   @map("payload_json")
  at          DateTime @default(now())

  @@index([userId, at])
  @@map("provider_events")
}
