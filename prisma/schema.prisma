// Yohaku Action Cloud - Phase1 Schema (Exit-first)
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================
// Phase1 Core Tables (本番)
// =========================================

// Tenants - 組織単位
model Tenant {
  id           String    @id @default(cuid())
  name         String
  region       String    @default("JP") // JP|US|EU
  status       String    @default("active") // active|frozen
  frozenReason String?   @map("frozen_reason")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  users             User[]
  apiKeys           ApiKey[]
  proposals         Proposal[]
  plans             Plan[]
  approvals         Approval[]
  auditLogs         AuditLog[]
  ledgerEvents      LedgerEvent[]
  freezeRules       FreezeRule[]
  connectorConfigs  ConnectorConfig[]
  webhookJobs       WebhookJob[]
  receipts          Receipt[]
  growthEvents      GrowthEvent[]
  billingContracts  BillingContract[]
  usageCounters     UsageCounterDaily[]
  invoices          Invoice[]

  @@map("tenants")
}

// Users - テナント内のユーザー
model User {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  emailHash  String   @map("email_hash")
  role       String   @default("member") // admin|member|viewer
  createdAt  DateTime @default(now()) @map("created_at")

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  proposals Proposal[]
  plans     Plan[]
  approvals Approval[]
  auditLogs AuditLog[]

  @@unique([tenantId, emailHash])
  @@index([tenantId, createdAt])
  @@map("users")
}

// API Keys - テナント単位の認証
model ApiKey {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  name       String
  keyHash    String    @unique @map("key_hash")
  scopesJson String    @map("scopes_json") // ["plan:write", "approve:write", "confirm:write", "ledger:read", "billing:read"]
  createdAt  DateTime  @default(now()) @map("created_at")
  revokedAt  DateTime? @map("revoked_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@map("api_keys")
}

// Proposals - 提案（複数プラン）
model Proposal {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  payloadJson String   @map("payload_json")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  plans  Plan[]

  @@index([tenantId, createdAt])
  @@map("proposals")
}

// Plans - 実行プラン
model Plan {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  proposalId  String?  @map("proposal_id")
  payloadJson String   @map("payload_json") // { "actions": [...], "confirm_sheet": {...} }
  createdAt   DateTime @default(now()) @map("created_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  proposal     Proposal?     @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  approvals    Approval[]
  ledgerEvents LedgerEvent[]
  receipts     Receipt[]

  @@index([tenantId, createdAt])
  @@map("plans")
}

// Approvals - 承認（TTL10分）
model Approval {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  approveId  String    @unique @map("approve_id") // aprv_xxx
  planId     String?   @map("plan_id")
  scopeJson  String    @map("scope_json") // { "actions": [...], "risk_level": "low|medium|high" }
  expiresAt  DateTime  @map("expires_at") // 10分後
  createdAt  DateTime  @default(now()) @map("created_at")
  usedAt     DateTime? @map("used_at")

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan?         @relation(fields: [planId], references: [id], onDelete: SetNull)
  auditLogs     AuditLog[]
  ledgerEvents  LedgerEvent[]

  @@index([approveId])
  @@index([tenantId, createdAt])
  @@map("approvals")
}

// Audit Logs - 監査ログ
model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  approveId   String?  @map("approve_id")
  action      String   // approve|confirm|cancel|rollback|freeze|unfreeze
  payloadJson String   @map("payload_json")
  at          DateTime @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  approval Approval? @relation(fields: [approveId], references: [id], onDelete: SetNull)

  @@index([tenantId, at])
  @@index([approveId])
  @@map("audit_logs")
}

// Execution Ledger - 台帳（append-only chain）
model LedgerEvent {
  id           String    @id @default(cuid())
  tenantId     String    @map("tenant_id")
  approveId    String?   @map("approve_id")
  planId       String?   @map("plan_id")
  action       String    // webhook.dispatch|calendar.hold.create
  actor        String    // user|automation
  status       String    // approved|executed|failed|rolled_back
  beforeJson   String?   @map("before_json")
  afterJson    String?   @map("after_json")
  reversible   Boolean   @default(true)
  rollbackId   String?   @map("rollback_id")
  ts           DateTime  @default(now())
  prevHash     String?   @map("prev_hash") // 改ざん検知用ハッシュチェーン

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approval Approval? @relation(fields: [approveId], references: [id], onDelete: SetNull)
  plan     Plan?     @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([tenantId, ts])
  @@index([approveId, ts])
  @@index([planId, ts])
  @@map("ledger_events")
}

// Freeze Rules - Kill/Freeze
model FreezeRule {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  level         String    // global|tenant|connector|target
  connector     String?   // webhook|calendar_hold
  targetUrlHash String?   @map("target_url_hash")
  active        Boolean   @default(true)
  reason        String
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, active])
  @@index([level, active])
  @@map("freeze_rules")
}

// Connector Configs - コネクタ設定
model ConnectorConfig {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  connector  String   // webhook|calendar_hold
  configJson String   @map("config_json")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, connector])
  @@map("connector_configs")
}

// Webhook Jobs - Webhook配信ジョブ
model WebhookJob {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  jobId         String    @unique @map("job_id")
  targetUrlHash String    @map("target_url_hash")
  payloadJson   String    @map("payload_json")
  signature     String
  status        String    @default("queued") // queued|delivering|succeeded|failed
  attempts      Int       @default(0)
  nextAttemptAt DateTime? @map("next_attempt_at")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([nextAttemptAt])
  @@map("webhook_jobs")
}

// Receipts - 実行レシート
model Receipt {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  planId      String   @map("plan_id")
  status      String   // success|partial|failed
  summaryText String   @map("summary_text")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan         Plan          @relation(fields: [planId], references: [id], onDelete: Cascade)
  receiptLinks ReceiptLink[]

  @@index([tenantId, createdAt])
  @@map("receipts")
}

// Receipt Links - レシート共有リンク（Team Viral）
model ReceiptLink {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  receiptId  String    @map("receipt_id")
  tokenHash  String    @unique @map("token_hash")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  receipt Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@map("receipt_links")
}

// Growth Events - PLG計測
model GrowthEvent {
  id       String   @id @default(cuid())
  tenantId String   @map("tenant_id")
  type     String   // approve_link_opened|receipt_shared|template_exported|template_imported
  metaJson String   @map("meta_json")
  at       DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, at])
  @@map("growth_events")
}

// =========================================
// Billing（phase1：メータリング必須 / 請求は手動でもOK）
// =========================================

// Billing Contracts - 契約プラン
model BillingContract {
  id                          String    @id @default(cuid())
  tenantId                    String    @map("tenant_id")
  plan                        String    // design_partner|private_beta_starter|private_beta_pro
  currency                    String    @default("JPY")
  platformFeeJpy              Int       @map("platform_fee_jpy")
  includedConfirms            Int       @map("included_confirms")
  includedWebhookJobs         Int       @map("included_webhook_jobs")
  includedCalendarHolds       Int       @map("included_calendar_holds")
  overageConfirmJpy           Float     @map("overage_confirm_jpy")
  overageWebhookJobJpy        Float     @map("overage_webhook_job_jpy")
  overageCalendarHoldJpy      Float     @map("overage_calendar_hold_jpy")
  effectiveFrom               DateTime  @map("effective_from")
  effectiveTo                 DateTime? @map("effective_to")
  createdAt                   DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, effectiveFrom])
  @@map("billing_contracts")
}

// Usage Counters Daily - 日次使用量
model UsageCounterDaily {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  day            DateTime @db.Date
  confirms       Int      @default(0)
  webhookJobs    Int      @default(0) @map("webhook_jobs")
  calendarHolds  Int      @default(0) @map("calendar_holds")
  createdAt      DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, day])
  @@index([tenantId, day])
  @@map("usage_counters_daily")
}

// Invoices - 請求書
model Invoice {
  id             String    @id @default(cuid())
  tenantId       String    @map("tenant_id")
  month          String    // YYYY-MM
  platformFeeJpy Int       @map("platform_fee_jpy")
  overageFeeJpy  Int       @map("overage_fee_jpy")
  creditsJpy     Int       @default(0) @map("credits_jpy") // Treaty補償
  totalJpy       Int       @map("total_jpy")
  status         String    @default("draft") // draft|issued|paid
  issuedAt       DateTime? @map("issued_at")
  paidAt         DateTime? @map("paid_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId, status])
  @@map("invoices")
}

// =========================================
// SEALED（phase1はテーブルだけ / 実行パスは禁止）
// =========================================

// Call Jobs - Phone connector用（phase1実行禁止）
model CallJob {
  id          String    @id @default(cuid())
  tenantId    String    @map("tenant_id")
  jobId       String    @unique @map("job_id")
  phoneNumber String    @map("phone_number")
  purpose     String
  status      String    @default("queued") // queued|calling|completed|failed
  transcript  String?
  summary     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([tenantId, status])
  @@map("call_jobs")
}

// Memories - Memory OS（phase1は最小ログのみ）
model Memory {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  kind       String    // preference|fact|alias|goal|routine
  key        String
  valueJson  String    @map("value_json")
  source     String?   // utterance|action|import|manual
  confidence Float?    @default(1.0)
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, userId, key])
  @@index([tenantId, userId, key])
  @@map("memories")
}

// Observations - Proactive OS（phase1は実行禁止）
model Observation {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  signal      String   // free_slot|relationship_gap|deadline_near
  payloadJson String   @map("payload_json")
  observedAt  DateTime @default(now()) @map("observed_at")

  @@index([tenantId, userId, observedAt])
  @@map("observations")
}

// Nudges - Proactive OS（phase1は実行禁止）
model Nudge {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  summary    String
  planJson   String    @map("plan_json")
  reasonKeys String[]  @map("reason_keys")
  status     String    @default("shown") // shown|accepted|dismissed|expired
  createdAt  DateTime  @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")

  @@index([tenantId, userId, createdAt])
  @@map("nudges")
}

// Contact Graph - Relationship Graph（phase1は実行禁止）
model ContactGraph {
  tenantId     String    @map("tenant_id")
  userId       String    @map("user_id")
  contactId    String    @map("contact_id")
  tieStrength  Float?    @map("tie_strength")
  lastMetAt    DateTime? @map("last_met_at")
  lastMsgAt    DateTime? @map("last_msg_at")
  cadenceDays  Int?      @map("cadence_days")
  channelsJson String?   @map("channels_json")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@id([tenantId, userId, contactId])
  @@index([tenantId, userId, updatedAt])
  @@map("contact_graph")
}

// Marketplace Listings - Connector SDK（phase3）
model MarketplaceListing {
  id          String   @id @default(cuid())
  connectorId String   @unique @map("connector_id")
  name        String
  description String
  status      String   @default("draft") // draft|published|archived
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("marketplace_listings")
}
